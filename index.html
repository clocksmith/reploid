<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><defs><linearGradient id='g' x1='0%25' y1='0%25' x2='100%25' y2='100%25'><stop offset='0%25' style='stop-color:%230ff;'/><stop offset='100%25' style='stop-color:%23ffd700;'/></linearGradient></defs><text fill='url(%23g)' x='50%25' y='50%25' font-size='95' font-weight='bold' text-anchor='middle' dominant-baseline='central'>R</text></svg>" />
    <title>Reploid</title>
    <link rel="stylesheet" href="styles/theme.css">
    <link rel="stylesheet" href="styles/boot.css">
    <link rel="stylesheet" href="styles/proto.css">
    <!-- xterm.js styles for CLI mode -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.min.css">

    <!-- Load WebLLM and expose to window for llm-client.js -->
    <script type="module">
        import * as webllm from "https://esm.run/@mlc-ai/web-llm";
        window.webllm = webllm;
        console.log("[System] WebLLM Loaded");
    </script>

    <!-- Load Transformers.js for newer models (Qwen3, Gemma3, etc.) -->
    <script type="module">
        import { pipeline, env } from "https://cdn.jsdelivr.net/npm/@huggingface/transformers@3";
        // Configure for WebGPU
        env.backends.onnx.wasm.proxy = false;
        window.transformers = { pipeline, env };
        console.log("[System] Transformers.js Loaded");
    </script>

    <!-- Service Worker Module Loader (Self-Hosting VFS Architecture) -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw-module-loader.js')
            .then(reg => {
              console.log('[SW] Service Worker registered for VFS module loading');
              // Store reference for later use
              window.REPLOID_SW = reg;
            })
            .catch(err => {
              console.warn('[SW] Service Worker registration failed:', err);
              console.warn('[SW] Modules will load from network instead');
            });
        });
      }
    </script>

    <!-- Firebase Analytics -->
    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
      import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js';

      const firebaseConfig = {
        apiKey: "AIzaSyBNjEuGLafsUde3ws_9_Zi-PUlKkWt-CWM",
        authDomain: "reploid.firebaseapp.com",
        projectId: "reploid",
        storageBucket: "reploid.firebasestorage.app",
        messagingSenderId: "506730551098",
        appId: "1:506730551098:web:1b9639865cb8501b7c2203",
        measurementId: "G-RL299QYBNB"
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
    </script>
</head>
<body>
    <div id="boot-container">
        <div class="boot-header">
            <h1>REPLOID</h1>
            <p class="subtitle">
                <a href="https://github.com/clocksmith/reploid" target="_blank" class="subtitle-link">Browser-native sandbox for safe AI agent development</a>
            </p>
        </div>

        <div id="api-error-message" class="error-message hidden" role="alert">
            <strong>Server Offline</strong>
            <p>Reploid can't reach <code>localhost:8000</code>.</p>
            <p><code>npm start</code> to boot the service, or read the <a href="https://github.com/clocksmith/deco/tree/main/docs" target="_blank" rel="noreferrer">setup guide</a>.</p>
        </div>

        <!-- Quick Start -->
        <h4 class="section-header">Quick Start</h4>
        <div class="webllm-demo-card">
            <div class="webllm-demo-desc">
                Run local browser model (Qwen 2.5 3B) to analyze and improve the agent's code.<br>
                Download via WebLLM is ~3GB for first time.
            </div>
            <button id="quick-webllm-demo-btn" class="btn primary webllm-demo-btn">Go!</button>
        </div>

        <!-- Connection Status -->
        <h4 class="section-header">Connection Status</h4>
        <div class="provider-status-bar">
            <div class="provider-status-item">
                <span class="provider-status-icon online" id="browser-cloud-icon">☁</span>
                <span class="provider-status-label">Browser → Cloud</span>
                <span class="provider-status-value online" id="browser-cloud-text">Ready</span>
            </div>
            <div class="provider-status-item">
                <span class="provider-status-icon" id="proxy-cloud-icon">⇄</span>
                <span class="provider-status-label">Proxy → Cloud</span>
                <span class="provider-status-value" id="proxy-cloud-text">Checking...</span>
            </div>
            <div class="provider-status-item">
                <span class="provider-status-icon" id="browser-local-icon">◆</span>
                <span class="provider-status-label">Browser → Local</span>
                <span class="provider-status-value" id="browser-local-text">Checking...</span>
            </div>
            <div class="provider-status-item">
                <span class="provider-status-icon" id="proxy-local-icon">☒</span>
                <span class="provider-status-label">Proxy → Local</span>
                <span class="provider-status-value" id="proxy-local-text">Checking...</span>
            </div>
        </div>

        <!-- Model Cards Container -->
        <h4 class="section-header">Active Models</h4>
        <div class="model-cards-container" style="width: 100%;">

                <div class="model-cards-list" id="model-cards-list">
                    <!-- Model cards will be added here dynamically -->

                    <!-- Add Model card - always visible -->
                    <div class="model-card add-model-card" id="add-model-card">
                        <div class="add-model-icon">+</div>
                        <div class="add-model-text">Add Model</div>
                    </div>
                </div>

                <!-- Model Form Modal (moved to overlay) -->
                <div id="model-form-overlay" class="model-form-overlay">
                    <div id="model-form-dialog" class="model-form-dialog">
                        <div class="model-form-header">
                            <h5 id="model-form-title">Add Model</h5>
                            <button class="close-btn-small" id="close-model-form">×</button>
                        </div>

                        <!-- Provider Selection -->
                        <div class="inline-form-row">
                            <label>Provider</label>
                            <select id="provider-select" class="inline-select">
                                <option value="">Select provider...</option>
                            </select>
                        </div>

                        <!-- Model Selection -->
                        <div class="inline-form-row hidden" id="model-select-group">
                            <label>Model</label>
                            <select id="model-select-dropdown" class="inline-select">
                                <option value="">Select model...</option>
                            </select>
                        </div>

                        <!-- API Key (if needed) -->
                        <div class="inline-form-row hidden" id="api-key-group">
                            <label>API Key</label>
                            <input type="password" id="model-api-key" class="inline-input" placeholder="Enter API key..." />
                        </div>

                        <!-- Connection Type Selection -->
                        <div class="inline-form-row hidden" id="connection-type-group">
                            <label>Connection</label>
                            <select id="connection-type-select" class="inline-select">
                                <option value="">Select connection type...</option>
                            </select>
                        </div>

                        <div class="inline-form-actions">
                            <button class="inline-btn-cancel" id="cancel-model-btn">Cancel</button>
                            <button class="inline-btn-save" id="save-model-btn" disabled>Add Model</button>
                        </div>
                    </div>
                </div>

                <!-- Consensus Strategy (shown when 2+ models) -->
                <div id="consensus-section" class="consensus-section hidden">
                    <label for="consensus-strategy">Consensus Strategy</label>
                    <select id="consensus-strategy" class="consensus-select">
                        <option value="arena">Model Arena</option>
                        <option value="peer-review">Peer Review</option>
                    </select>
                </div>
            </div>

        <!-- Genesis Level Selection -->
        <h4 class="section-header">Genesis Level</h4>
        <div class="config-section">
            <div class="boot-mode-options">
                <button class="boot-mode-btn selected recommended" data-genesis="full" onclick="selectGenesisLevel('full')">
                    <div class="boot-mode-badge">RECOMMENDED</div>
                    <div class="boot-mode-label">FULL SUBSTRATE</div>
                    <div class="boot-mode-desc">All capabilities - cognition, testing, shell tools (ls, grep, git)</div>
                </button>
                <button class="boot-mode-btn" data-genesis="minimal" onclick="selectGenesisLevel('minimal')">
                    <div class="boot-mode-badge experimental-badge">EXPERIMENTAL</div>
                    <div class="boot-mode-label">MINIMAL AXIOMS</div>
                    <div class="boot-mode-desc">Core + basic performance monitoring</div>
                </button>
                <button class="boot-mode-btn" data-genesis="tabula" onclick="selectGenesisLevel('tabula')">
                    <div class="boot-mode-badge experimental-badge">EXPERIMENTAL</div>
                    <div class="boot-mode-label">TABULA RASA</div>
                    <div class="boot-mode-desc">Core agent + reflection only - no advanced capabilities</div>
                </button>
            </div>

        </div>

        <!-- Goal Input -->
        <h4 class="section-header" style="margin-top: 30px;">Agent Mission</h4>
        <div class="goal-container-top">
            <div class="goal-input-group">
                <input type="text" id="goal-input" placeholder="Describe a goal..." maxlength="500" disabled />
                <button id="awaken-btn" class="btn primary" disabled>Awaken Agent</button>
                <input type="file" id="import-file-input" accept=".json" style="display: none;" />
            </div>
            <!-- Example Goal Chips -->
            <div class="goal-example-chips">
                <button class="goal-chip" onclick="document.getElementById('goal-input').value='Analyze your source code in /core and /capabilities, identify bottlenecks, and propose concrete improvements to enhance task-solving ability'">Improve Task Solving</button>
                <button class="goal-chip" onclick="document.getElementById('goal-input').value='Create a tool that generates new tools based on analyzing your current tool usage patterns and capability gaps'">Build Tool Generator</button>
                <button class="goal-chip" onclick="document.getElementById('goal-input').value='Use semantic memory to build a hierarchical understanding of your own architecture, then identify recursive improvement opportunities'">Map Self-Architecture</button>
                <button class="goal-chip" onclick="document.getElementById('goal-input').value='Design a meta-tool that can analyze, compose, and optimize existing tools to create higher-order capabilities'">Create Meta-Tool</button>
                <button class="goal-chip" onclick="document.getElementById('goal-input').value='Analyze your reflection logs to identify patterns in successful self-improvement, then codify them as new strategic rules'">Learn from Reflections</button>
                <button class="goal-chip" onclick="document.getElementById('goal-input').value='Build a capability assessment system that benchmarks your current abilities and generates goals to address weaknesses'">Self-Assess Capabilities</button>
                <button class="goal-chip" onclick="document.getElementById('goal-input').value='Create a recursive tool chain: a tool that builds tools that enhance tools, with semantic validation at each layer'">Recursive Tool Chain</button>
                <button class="goal-chip" onclick="document.getElementById('goal-input').value='Analyze safety constraints in verification-manager.js, identify blind spots, and propose self-improving safety mechanisms'">Enhance Safety System</button>
            </div>
        </div>

        <!-- System Actions -->
        <div class="system-actions" style="margin-top: 20px;">
            <button id="import-state-btn" class="btn secondary" title="Import REPLOID state from exported JSON file">Import State</button>
            <button id="clear-cache-btn" class="btn secondary" title="Clear all data (localStorage, IndexedDB, VFS) and reload">Reset All Data</button>
        </div>

        <!-- Info Overlay -->
        <div id="info-overlay" class="info-overlay hidden">
            <div class="info-card">
                <div class="info-card-header">
                    <h3 id="info-card-title">Info</h3>
                    <button type="button" class="close-btn" onclick="window.closeInfoCard()">×</button>
                </div>
                <div id="info-card-body" class="info-card-body"></div>
                <div class="info-card-footer">
                    <button type="button" id="info-card-browse" class="secondary-btn">Browse Directory →</button>
                </div>
            </div>
        </div>

        <!-- Directory Browser -->
        <div id="directory-modal" class="modal hidden">
            <div class="modal-content directory-modal-content">
                <div class="modal-header">
                    <h3 id="directory-modal-title">Module Directory</h3>
                    <button type="button" class="close-btn" onclick="window.closeDirectoryModal()">×</button>
                </div>
                <div class="modal-body directory-modal-body">
                    <div class="directory-filters" role="group" aria-label="Select preset">
                        <button type="button" class="directory-filter active" data-preset="core" onclick="switchModulePreset('core')">CORE</button>
                        <button type="button" class="directory-filter" data-preset="headless" onclick="switchModulePreset('headless')">HEADLESS</button>
                        <button type="button" class="directory-filter" data-preset="complete" onclick="switchModulePreset('complete')">COMPLETE</button>
                    </div>
                    <div class="directory-content" id="directory-content"></div>
                </div>
            </div>
        </div>

        <div id="help-popover" class="help-popover hidden" role="dialog" aria-modal="false" aria-hidden="true">
            <div class="help-popover-content">
                <div class="help-popover-header">
                    <div id="help-popover-title" class="help-popover-title">Help</div>
                    <button type="button" class="close-btn help-popover-close" aria-label="Close help popover">×</button>
                </div>
                <div id="help-popover-body" class="help-popover-body"></div>
            </div>
        </div>

        <div id="multi-model-modal" class="modal hidden" role="dialog" aria-modal="true" aria-hidden="true">
            <div class="modal-content multi-model-modal-content">
                <div class="modal-header">
                    <h3>Multi-Model Setup</h3>
                    <button type="button" class="close-btn" id="close-multi-model">×</button>
                </div>
                <div class="modal-body">
                    <p class="settings-description">Define primary, fallback, and consensus models for Arena competitive testing.</p>
                    <div class="arena-field">
                        <label for="arena-primary">Primary Model</label>
                        <input type="text" id="arena-primary" placeholder="e.g., gemini-2.5-flash-lite" />
                    </div>
                    <div class="arena-field">
                        <label for="arena-fallback">Fallback Model</label>
                        <input type="text" id="arena-fallback" placeholder="e.g., gpt-5-2025-08-07" />
                    </div>
                    <div class="arena-field">
                        <label for="arena-consensus">Consensus Model</label>
                        <input type="text" id="arena-consensus" placeholder="e.g., claude-4-5-sonnet" />
                    </div>
                    <div class="arena-field">
                        <label for="arena-strategy">Strategy</label>
                        <select id="arena-strategy">
                            <option value="fastest">Fastest First</option>
                            <option value="consensus">Consensus Vote</option>
                            <option value="fallback">Fallback Chain</option>
                        </select>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn secondary" id="cancel-multi-model">Cancel</button>
                        <button type="button" class="btn primary" id="save-multi-model">Save Multi-Model Plan</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Boot mode selection
        let selectedBootMode = 'single'; // Default

        function selectBootMode(mode) {
            selectedBootMode = mode;
            console.log('[Boot] Selected mode:', mode);

            // Update UI
            document.querySelectorAll('.boot-mode-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelector(`[data-mode="${mode}"]`).classList.add('selected');

            // Store selection
            localStorage.setItem('reploid_boot_mode', mode);
        }

        // Module browser
        function openModuleBrowser() {
            alert('Module browser coming soon!\n\nYou can manually configure modules by editing boot.js.\n\nCurrent mode: ' + selectedBootMode);
        }

        // Restore saved boot mode
        window.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem('reploid_boot_mode');
            if (saved) {
                selectBootMode(saved);
            }
        });
    </script>

    <!-- Mode toggle (Dashboard / CLI) -->
    <div id="mode-toggle" class="mode-toggle hidden">
      <button id="mode-dashboard-btn" class="mode-btn active" title="Dashboard Mode">
        <span class="mode-icon">◫</span>
        <span class="mode-label">Dashboard</span>
      </button>
      <button id="mode-cli-btn" class="mode-btn" title="CLI Mode (Ctrl+`)">
        <span class="mode-icon">▸_</span>
        <span class="mode-label">Terminal</span>
      </button>
    </div>

    <!-- App container for dashboard -->
    <div id="app"></div>

    <!-- CLI terminal container -->
    <div id="cli-container" class="cli-container hidden"></div>
    <!-- Dev integrations loaded conditionally via boot.js -->
    <script type="module" src="boot.js"></script>
</body>
</html>

<script>
// Genesis level selection
let selectedGenesisLevel = localStorage.getItem('REPLOID_GENESIS_LEVEL') || 'full';
let genesisLevelLoaded = false;

function selectGenesisLevel(level) {
  const previousLevel = localStorage.getItem('REPLOID_GENESIS_LEVEL');

  // Update UI immediately
  document.querySelectorAll('[data-genesis]').forEach(btn => {
    btn.classList.remove('selected');
  });
  document.querySelector(`[data-genesis="${level}"]`).classList.add('selected');

  // Store selection
  localStorage.setItem('REPLOID_GENESIS_LEVEL', level);
  selectedGenesisLevel = level;

  console.log(`[Config] Genesis level set to: ${level}`);

  // If changing from a previously loaded level, reload for full sweep
  if (previousLevel && previousLevel !== level && genesisLevelLoaded) {
    console.log(`[Config] Genesis level changed from ${previousLevel} to ${level}, reloading...`);
    location.reload();
  }
}

// Called by boot.js when system is ready
window.onGenesisLevelLoaded = () => {
  genesisLevelLoaded = true;
  console.log(`[Config] Genesis level ${selectedGenesisLevel} loaded successfully`);
};

// Restore saved genesis level on load
window.addEventListener('DOMContentLoaded', () => {
  const savedLevel = localStorage.getItem('REPLOID_GENESIS_LEVEL');
  if (savedLevel && ['full', 'minimal', 'tabula', 'cli'].includes(savedLevel)) {
    // Just update UI, don't trigger reload
    document.querySelectorAll('[data-genesis]').forEach(btn => {
      btn.classList.remove('selected');
    });
    const btn = document.querySelector(`[data-genesis="${savedLevel}"]`);
    if (btn) btn.classList.add('selected');
    selectedGenesisLevel = savedLevel;
  }
});

// Expose genesis level for boot.js
window.getGenesisLevel = () => selectedGenesisLevel;

// Reset All Data button handler
window.addEventListener('DOMContentLoaded', () => {
  const clearBtn = document.getElementById('clear-cache-btn');
  if (clearBtn) {
    clearBtn.addEventListener('click', async () => {
      if (!confirm('This will delete ALL data including:\n\n• LocalStorage settings\n• IndexedDB (VFS, reflections, state)\n• Selected models\n\nAre you sure?')) {
        return;
      }

      // Clear localStorage
      localStorage.clear();

      // Clear all IndexedDB databases
      const databases = await indexedDB.databases();
      for (const db of databases) {
        if (db.name) {
          indexedDB.deleteDatabase(db.name);
          console.log(`[Reset] Deleted IndexedDB: ${db.name}`);
        }
      }

      console.log('[Reset] All data cleared, reloading...');
      location.reload();
    });
  }
});

// Concurrency limit management
window.addEventListener('DOMContentLoaded', () => {
  const concurrencyInput = document.getElementById('concurrency-limit');
  if (concurrencyInput) {
    // Load saved value
    const saved = localStorage.getItem('MAX_CONCURRENT_PROXY_REQUESTS');
    if (saved) {
      concurrencyInput.value = saved;
    }

    // Save on change
    concurrencyInput.addEventListener('change', (e) => {
      const value = parseInt(e.target.value);
      if (value >= 1 && value <= 10) {
        localStorage.setItem('MAX_CONCURRENT_PROXY_REQUESTS', value);
        console.log(`[Config] Concurrency limit set to: ${value}`);
        alert(`Concurrency limit set to ${value}. Refresh the page for changes to take effect.`);
      }
    });
  }
});
</script>

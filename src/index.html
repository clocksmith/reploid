<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes"
    />
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <title>Reploid</title>

    <link rel="stylesheet" href="styles/rd.css?v=1735500000" />
    <link rel="stylesheet" href="styles/boot.css?v=1735500000" />

    <script type="importmap">
      {
        "imports": {
          "@clocksmith/doppler": "/vendor/doppler/index.js",
          "@clocksmith/doppler/provider": "/vendor/doppler/doppler-provider.js",
          "@clocksmith/doppler/bridge/": "/vendor/doppler/bridge/",
          "@clocksmith/doppler/browser/": "/vendor/doppler/browser/",
          "@clocksmith/doppler/": "/vendor/doppler/"
        }
      }
    </script>

    <!-- Service Worker Module Loader (Self-Hosting VFS Architecture) -->
    <script>
      if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
          navigator.serviceWorker
            .register("./sw-module-loader.js")
            .then((reg) => {
              console.log(
                "[SW] Service Worker registered for VFS module loading"
              );
              window.REPLOID_SW = reg;
            })
            .catch((err) => {
              console.warn("[SW] Service Worker registration failed:", err);
            });
        });
      }
    </script>
  </head>
  <body>
    <!-- Boot Wizard -->
    <div id="wizard-container" class="wizard-container" style="display: none">
      <!-- Wizard content rendered by ui/boot/index.js -->
    </div>

    <!-- App container for main UI -->
    <div id="app"></div>

    <script>
      // Perform full reset (preserves API keys)
      async function performFullReset() {
        const steps = [];

        // Service Workers
        if ("serviceWorker" in navigator) {
          const regs = await navigator.serviceWorker.getRegistrations();
          await Promise.all(regs.map((reg) => reg.unregister()));
          steps.push(`Unregistered ${regs.length} service worker(s)`);
        }

        // Browser Caches
        if ("caches" in window) {
          const cacheNames = await caches.keys();
          await Promise.all(cacheNames.map((name) => caches.delete(name)));
          steps.push(`Cleared ${cacheNames.length} cache(s)`);
        }

        // LocalStorage (preserve API keys)
        const keysToPreserve = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && (key.includes("KEY_") || key.includes("api_key"))) {
            keysToPreserve.push({ key, value: localStorage.getItem(key) });
          }
        }
        const lsCount = localStorage.length;
        localStorage.clear();
        keysToPreserve.forEach(({ key, value }) =>
          localStorage.setItem(key, value)
        );
        steps.push(
          `Cleared ${lsCount - keysToPreserve.length} localStorage keys`
        );

        // IndexedDB
        if ("databases" in indexedDB) {
          const dbs = await indexedDB.databases();
          await Promise.all(
            dbs.map(
              (db) =>
                new Promise((resolve) => {
                  const timeoutId = setTimeout(() => resolve(), 3000);
                  const req = indexedDB.deleteDatabase(db.name);
                  req.onsuccess = () => {
                    clearTimeout(timeoutId);
                    resolve();
                  };
                  req.onerror = () => {
                    clearTimeout(timeoutId);
                    resolve();
                  };
                  req.onblocked = () => {
                    clearTimeout(timeoutId);
                    resolve();
                  };
                })
            )
          );
          steps.push(`Deleted ${dbs.length} database(s)`);
        }

        console.log("[Reset]", steps.join("; "));
        return steps;
      }

      // Clear only VFS (IndexedDB) - lighter reset for awaken
      async function clearVFS() {
        if (!("databases" in indexedDB)) {
          console.log("[Reset] indexedDB.databases not supported, skipping VFS clear");
          return [];
        }
        const dbs = await indexedDB.databases();
        await Promise.all(
          dbs.map(
            (db) =>
              new Promise((resolve) => {
                const timeoutId = setTimeout(() => resolve(), 3000);
                const req = indexedDB.deleteDatabase(db.name);
                req.onsuccess = () => {
                  clearTimeout(timeoutId);
                  resolve();
                };
                req.onerror = () => {
                  clearTimeout(timeoutId);
                  resolve();
                };
                req.onblocked = () => {
                  clearTimeout(timeoutId);
                  resolve();
                };
              })
          )
        );
        console.log(`[Reset] Cleared ${dbs.length} VFS database(s)`);
        return [`Cleared ${dbs.length} VFS database(s)`];
      }

      // Expose reset functions for boot.js
      window.shouldResetAll = () =>
        localStorage.getItem("REPLOID_RESET_ALL") === "true";
      window.performFullReset = performFullReset;
      window.clearVFS = clearVFS;

      // Execution limits (used by agent-loop)
      window.getExecutionLimits = () => {
        const stored = localStorage.getItem("REPLOID_MAX_ITERATIONS");
        // 0 means no limit, null/undefined defaults to 25
        const maxIterations =
          stored === "0" ? Infinity : parseInt(stored) || 25;
        return {
          maxIterations,
          approvalInterval:
            parseInt(localStorage.getItem("REPLOID_APPROVAL_INTERVAL")) || 0,
        };
      };

      // Genesis level (used by boot)
      window.getGenesisLevel = () =>
        localStorage.getItem("REPLOID_GENESIS_LEVEL") || "full";

      // Cognition config (used by memory systems)
      window.getCognitionConfig = () => {
        try {
          return JSON.parse(
            localStorage.getItem("REPLOID_COGNITION_CONFIG") || "{}"
          );
        } catch {
          return {};
        }
      };

      // GEPA config (used by GEPA optimizer)
      window.getGEPAConfig = () => {
        try {
          return JSON.parse(
            localStorage.getItem("REPLOID_GEPA_CONFIG") || "{}"
          );
        } catch {
          return {};
        }
      };
    </script>

    <script type="module" src="boot.js?v=1735500000"></script>
  </body>
</html>

<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>[WIP] Design Deliberation &amp; Action Agent (DDAA)</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.6;
            margin: 0;
            padding: 16px;
            background-color: #f9f9f9;
            color: #333;
        }
        .container {
            max-width: 950px;
            margin: 20px auto;
            padding: 25px;
            background-color: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        h1, h2, h3 {
            color: #2c3e50;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
            margin-top: 40px;
        }
        h1 {
            text-align: center;
            border-bottom: none;
            margin-bottom: 10px;
            color: #3498db;
        }
        h4 {
             color: #301934;
             border: 1px dashed black;
             padding: 8px;
             margin-bottom: 30px;
             text-align: center;
             font-weight: normal;
        }
        p, li {
            margin-bottom: 15px;
        }
        code, b {
            background-color: #ecf0f1;
            padding: 2px 5px;
            border-radius: 4px;
            font-family: "Courier New", Courier, monospace;
            color: #c0392b;
        }
        b {
             color: #2c3e50;
             background-color: #f9e79f;
             font-weight: bold;
        }
        pre {
            background-color: #34495e;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 0.9em;
        }
        pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
        }
        .concept-box {
            border: 1px solid #bdc3c7;
            background-color: #fdfefe;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .concept-box h3 {
            margin-top: 0;
            color: #16a085;
            border-bottom: 1px dashed #1abc9c;
        }
        .diagram-container {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 20px 0;
            background-color: #f8f9f9;
            border-radius: 5px;
            overflow: auto;
        }
        #cycleDiagram {
            display: block;
            width: 100%;
            min-height: 800px;
            max-height: 1200px;
        }
         svg {
             width: 100%;
             max-width: 850px;
             display: block;
             margin: 20px auto;
             height: auto;
        }
         #compression-viz, #subgraph-viz {
             border: 1px dashed #bdc3c7;
             padding: 10px;
             box-sizing: border-box;
             background-color: #fdfdfd;
             max-width: 700px;
         }
         #subgraph-viz-static {
             max-width: 850px; /* Allow original static SVG width */
         }
        .interactive-button {
            background-color: #3498db;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px 10px 0;
            transition: background-color 0.2s ease;
        }
        .interactive-button:hover {
            background-color: #2980b9;
        }
        .hidden { display: none; }
        .node-compressed { fill: #e67e22; }
        .subgraph-core { opacity: 0.5; }
        .subgraph-personal { stroke: #8e44ad; stroke-width: 2px; }
        .section { margin-bottom: 60px; }
        .algorithm-list { margin-top: 10px; }
        .algorithm-list li { margin-bottom: 5px; }
        table { border-collapse: collapse; width: 100%; max-width: 850px; margin: 25px auto; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
        th { background-color: #ecf0f1; color: #2c3e50; font-weight: bold; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .next-steps-list { margin-top: 10px; }
        .next-steps-list li { margin-bottom: 10px; }

        .node { cursor: pointer; transition: fill 0.2s ease; }
        .node:hover { fill: #f1c40f; }
        .node-text { font-size: 10px; pointer-events: none; }
        .edge { stroke: #7f8c8d; stroke-width: 1.5; }
        .edge-compressed { stroke: #e67e22; stroke-width: 2.5; stroke-dasharray: 4, 4; }
        .artifact { font-size: 9px; fill: #2980b9; font-style: italic; }

    </style>
</head>
<body>
    <div class="container">
        <h1>Design Deliberation &amp; Action Agent (DDAA) Concepts</h1>
        <h4> WIP: deliberation function or system </h4>

        <p>The Design Deliberation &amp; Action Agent (DDAA) is envisioned as an intelligent orchestrator for complex design workflows. It aims to automate tasks, leverage AI and human capabilities effectively, and continuously learn by navigating a dynamic landscape of tools and processes, ultimately acting as an adaptive co-pilot for designers.</p>

        <div class="concept-box">
            <h3>Foundation: Tools &amp; Communication (MCP &amp; Gemini FC)</h3>
            <p>DDAA interacts with its environment through well-defined tools, enabled by key technologies:</p>
            <ul>
                <li><strong>Gemini Function Calling (FC):</strong> Allows the underlying Large Language Model (LLM) to intelligently select and invoke specific tools or functions based on understanding user intent and the available tool descriptions.</li>
                <li><strong>Model Context Protocol (MCP):</strong> Provides a crucial standardized framework for applications and services to define and expose their "tools" (functions, data resources) to LLMs. This allows DDAA to discover, understand capabilities (inputs/outputs), and reliably execute a wide range of functions from different sources like web services, scripts, or even human prompts.</li>
            </ul>
            <p>These enable DDAA to translate high-level goals into concrete actions performed by specific, discoverable tools.</p>

            <h4>Conceptual MCP Tool Definition Examples:</h4>
             <pre><code class="language-javascript">server.tool(
  "generate_color_palette",
  { mood: z.string().describe("The mood, e.g., 'calm', 'energetic'") },
  async ({ mood }) =&gt; {
    const colors = invokeColorGeneration(mood);
    return { content: [{ type: "json", data: { palette: colors } }] };
  }
);

server.tool(
  "create_figma_file_from_specs",
  { specs_url: z.string().url().describe("URL to design specs") },
  async ({ specs_url }) =&gt; {
    const figma_url = runFigmaCreationScript(specs_url);
    if (figma_url) {
        return { content: [{ type: "text", text: `Figma file: ${figma_url}` }] };
    } else {
        return { content: [{ type: "text", text: "Error"}], isError: true };
    }
  }
);</code></pre>
        </div>

        <section class="section">
            <h2>Function Examples Catalog</h2>
            <p>The DDAA leverages a diverse set of functions, callable via MCP or Gemini FC, each with specific inputs, outputs, and execution methods.</p>
            <table>
              <thead>
                <tr>
                  <th>Function Name</th>
                  <th>Description</th>
                  <th>Input</th>
                  <th>Output</th>
                  <th>Execution Type</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><code>create_wireframe</code></td>
                  <td>Generates a wireframe diagram.</td>
                  <td><code>content_outline</code> (string)</td>
                  <td><code>wireframe_diagram_url</code> (string)</td>
                  <td>Webserver Agent</td>
                </tr>
                <tr>
                  <td><code>create_figma_file</code></td>
                  <td>Generates a Figma file.</td>
                  <td><code>google3 dir / specs_url</code> (string)</td>
                  <td><code>figma_file_url</code> (string)</td>
                  <td>Script Agent (Figma API)</td>
                </tr>
                <tr>
                  <td><code>generate_image_description</code></td>
                  <td>Creates a textual description of an image.</td>
                  <td><code>image_url</code> (string)</td>
                  <td><code>image_caption</code> (string)</td>
                  <td>LLM Function Call</td>
                </tr>
                <tr>
                  <td><code>create_moodboard</code></td>
                  <td>Generates a moodboard image based on description.</td>
                  <td><code>description</code> (string), <code>style</code> (string)</td>
                  <td><code>moodboard_url</code> (string)</td>
                  <td>Webserver Agent</td>
                </tr>
                <tr>
                  <td><code>analyze_design_principles</code></td>
                  <td>Analyzes an image for design principles.</td>
                  <td><code>design_image_path / url</code> (string)</td>
                  <td><code>design_analysis_json</code> (JSON)</td>
                  <td>Script Agent (Python)</td>
                </tr>
                <tr>
                  <td><code>get_user_feedback</code></td>
                  <td>Requests user feedback on a design concept.</td>
                  <td><code>design_concept_description / url</code> (string)</td>
                  <td><code>user_feedback_text</code> (string)</td>
                  <td>Human Agent (UI Prompt)</td>
                </tr>
                <tr>
                  <td><code>generate_color_palette</code></td>
                  <td>Creates a color palette based on a mood.</td>
                  <td><code>mood</code> (string)</td>
                  <td><code>color_palette_hex_codes</code> (list)</td>
                  <td>LLM Function Call</td>
                </tr>
                <tr>
                  <td><code>suggest_typography</code></td>
                  <td>Suggests typography styles for a given style.</td>
                  <td><code>style_keywords</code> (string)</td>
                  <td><code>typography_suggestions_json</code> (JSON)</td>
                  <td>LLM Function Call</td>
                </tr>
              </tbody>
            </table>
        </section>

        <section class="section">
            <h2>Core Algorithm: The Self-Optimizing Action Graph</h2>
            <p>DDAA's intelligence stems from its dynamic <strong>Action Graph</strong>â€”a map where nodes are tools and edges represent potential workflows or data flow (artifacts). Crucially, this graph learns and adapts.</p>

            <h3>Dynamic Pathfinding &amp; Dynamic Programming</h3>
            <p>When given a goal, DDAA must find the "best" path (sequence of tools) through the graph. Because tools are added, removed, or change in efficiency (cost/time), DDAA employs <strong>dynamic shortest path algorithms</strong>. Inspired by algorithms like Dijkstra's, Bellman-Ford, or more advanced incremental approaches (see Literature below), these allow efficient path recalculation without starting from scratch. This aligns with <strong>dynamic programming</strong> principles: breaking down the problem (the overall goal) into smaller subproblems (tool executions) and storing/reusing optimal solutions (paths) for those subproblems.</p>

            <h3>Recursive Improvement via Path Compression</h3>
            <p>A core innovation is <strong>Path Compression</strong>. If the agent observes a specific sequence of tools (a path) is frequently and successfully used for a sub-goal, it compresses this path into a single, new, higher-level tool node. This new tool is added to the Action Graph.</p>
            <p>This is fundamentally recursive: an agent uses existing tools (defined via MCP/FC), observes its own workflow, and *creates a new tool* that encapsulates that workflow. This new tool might itself call other agents or tools, potentially leading to further compressions down the line. It's a mechanism where <strong>agents using tools can lead to agents creating tools, which can call agents...</strong> continuously optimizing the graph.</p>

            <button class="interactive-button" onclick="toggleCompression()">Toggle Path Compression Example</button>
            <div id="compression-example-container">
              <svg id="compression-viz" viewBox="0 0 450 200">
                 <defs>
                    <marker id="arrow-comp" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                        <path d="M 0 0 L 10 5 L 0 10 z" fill="#7f8c8d"></path>
                    </marker>
                    <marker id="arrow-compressed" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                        <path d="M 0 0 L 10 5 L 0 10 z" fill="#e67e22"></path>
                    </marker>
                </defs>
                <g id="uncompressed-path">
                    <rect class="node" id="comp-node-1" x="10" y="30" width="100" height="30" rx="5" fill="#2ecc71"><title>Generate Keywords</title></rect>
                    <text class="node-text" x="60" y="50" text-anchor="middle" style="font-size: 10px; pointer-events: none;">Gen Keywords</text>
                    <rect class="node" id="comp-node-2" x="130" y="30" width="100" height="30" rx="5" fill="#2ecc71"><title>Generate Palette</title></rect>
                    <text class="node-text" x="180" y="50" text-anchor="middle" style="font-size: 10px; pointer-events: none;">Gen Palette</text>
                    <rect class="node" id="comp-node-3" x="250" y="30" width="100" height="30" rx="5" fill="#2ecc71"><title>Suggest Fonts</title></rect>
                    <text class="node-text" x="300" y="50" text-anchor="middle" style="font-size: 10px; pointer-events: none;">Suggest Fonts</text>
                    <rect class="node" id="comp-node-4" x="370" y="30" width="70" height="30" rx="5" fill="#3498db"><title>Generate Logo</title></rect>
                    <text class="node-text" x="405" y="50" text-anchor="middle" style="font-size: 10px; pointer-events: none;">Gen Logo</text>
                    <path class="edge" d="M 110 45 L 130 45" marker-end="url(#arrow-comp)"></path>
                    <path class="edge" d="M 230 45 L 250 45" marker-end="url(#arrow-comp)"></path>
                    <path class="edge" d="M 350 45 L 370 45" marker-end="url(#arrow-comp)"></path>
                    <text x="225" y="20" text-anchor="middle" font-size="12" fill="#555">Frequent Path (Uncompressed)</text>
                </g>
                 <g id="compressed-path" class="hidden">
                     <rect class="node node-compressed" id="comp-node-new" x="80" y="120" width="180" height="40" rx="5"><title>Generate Style Elements (Compressed Tool)</title></rect>
                    <text class="node-text" x="170" y="145" text-anchor="middle" fill="white" style="font-size: 10px; pointer-events: none;">Generate Style Elements</text>
                     <rect class="node" id="comp-node-4-after" x="300" y="125" width="70" height="30" rx="5" fill="#3498db"><title>Generate Logo</title></rect>
                    <text class="node-text" x="335" y="145" text-anchor="middle" style="font-size: 10px; pointer-events: none;">Gen Logo</text>
                     <path class="edge edge-compressed" d="M 260 140 L 300 140" marker-end="url(#arrow-compressed)" style="stroke: #e67e22; stroke-width: 2.5; stroke-dasharray: 4, 4;"></path>
                    <text x="225" y="180" text-anchor="middle" font-size="12" fill="#555">Compressed Path</text>
                 </g>
              </svg>
            </div>

            <h3>Relevant Literature &amp; Concepts:</h3>
              <ul class="algorithm-list">
                <li>Dynamic Shortest Path Algorithms (e.g., Ramalingam &amp; Reps, Frigioni et al., Demetrescu et al., Baswana &amp; Sen).</li>
                <li>General Dynamic Programming principles for optimization.</li>
                <li>Graph Summarization &amp; Compression techniques.</li>
                <li>Heuristic Search and Pathfinding (e.g., A* variants adapted for dynamic graphs).</li>
              </ul>
              <p>Initial implementations might use simpler algorithms like Dijkstra/Bellman-Ford with periodic updates, scaling to more advanced incremental algorithms as the graph complexity increases.</p>
        </section>

        <section class="section">
            <h2>The DDAA Operational Cycle: Action, Learning, and Adaptation</h2>
            <p>This diagram illustrates the core loop DDAA follows. It dictates how the agent tackles goals, navigates the Action Graph, learns from outcomes, and integrates human feedback.</p>
            <div class="diagram-container">
                <svg id="cycleDiagram" viewBox="30 -22.5 740 1275" preserveAspectRatio="xMidYMid meet"><defs><marker id="arrowhead" viewBox="0 0 10 10" refX="8" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="8" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#555"></path></marker><marker id="arrowhead-line_success" viewBox="0 0 10 10" refX="8" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="8" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#4caf50"></path></marker><marker id="arrowhead-line_fail" viewBox="0 0 10 10" refX="8" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="8" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#f44336"></path></marker><marker id="arrowhead-line_retry" viewBox="0 0 10 10" refX="8" refY="5" markerUnits="strokeWidth" markerWidth="8" markerHeight="8" orient="auto-start-reverse"><path d="M 0 0 L 10 5 L 0 10 z" fill="#ff9800"></path></marker></defs><g><rect x="320" y="17.5" width="160" height="65" rx="32.5" ry="32.5" fill="#f5f5f5" stroke="#333" stroke-width="2"></rect><text x="400" y="50" fill="#000" font-family="monospace" font-size="13" text-anchor="middle" dominant-baseline="middle"><tspan x="400" dy="0">Start Cycle</tspan></text></g><g><rect x="320" y="117.5" width="160" height="65" rx="8" ry="8" fill="#e0e0e0" stroke="#555" stroke-width="2"></rect><text x="400" y="150" fill="#000" font-family="monospace" font-size="13" text-anchor="middle" dominant-baseline="middle"><tspan x="400" dy="0">1. Define Goal</tspan></text></g><g><rect x="320" y="217.5" width="160" height="65" rx="8" ry="8" fill="#d0e0ff" stroke="#3366cc" stroke-width="2"></rect><text x="400" y="250" fill="#000" font-family="monospace" font-size="13" text-anchor="middle" dominant-baseline="middle"><tspan x="400" dy="-7.799999999999983">2. Analyze</tspan><tspan x="400" dy="15.6">(Pathfind/DP)</tspan></text></g><g><rect x="320" y="317.5" width="160" height="65" rx="8" ry="8" fill="#d0e0ff" stroke="#3366cc" stroke-width="2"></rect><text x="400" y="350" fill="#000" font-family="monospace" font-size="13" text-anchor="middle" dominant-baseline="middle"><tspan x="400" dy="-7.800000000000011">3. Propose</tspan><tspan x="400" dy="15.6">(Plan)</tspan></text></g><g><rect x="320" y="417.5" width="160" height="65" rx="8" ry="8" fill="#d0e0ff" stroke="#3366cc" stroke-width="2"></rect><text x="400" y="450" fill="#000" font-family="monospace" font-size="13" text-anchor="middle" dominant-baseline="middle"><tspan x="400" dy="-7.800000000000011">4. Generate Artifacts</tspan><tspan x="400" dy="15.6">(Exec Tools)</tspan></text></g><g><path d="M 400 505 L 445 550 L 400 595 L 355 550 Z" fill="#e0f0e0" stroke="#4caf50" stroke-width="2"></path><text x="400" y="550" fill="#000" font-family="monospace" font-size="13" text-anchor="middle" dominant-baseline="middle"><tspan x="400" dy="0">Generation OK?</tspan></text></g><g><path d="M 400 605 L 445 650 L 400 695 L 355 650 Z" fill="#e0f0e0" stroke="#4caf50" stroke-width="2"></path><text x="400" y="650" fill="#000" font-family="monospace" font-size="13" text-anchor="middle" dominant-baseline="middle"><tspan x="400" dy="0">5. Critique Trigger?</tspan></text></g><g><rect x="320" y="947.5" width="160" height="65" rx="8" ry="8" fill="#e0e0e0" stroke="#555" stroke-width="2"></rect><text x="400" y="980" fill="#000" font-family="monospace" font-size="13" text-anchor="middle" dominant-baseline="middle"><tspan x="400" dy="0">7. Refine &amp; Apply</tspan></text></g><g><path d="M 400 1035 L 445 1080 L 400 1125 L 355 1080 Z" fill="#e0f0e0" stroke="#4caf50" stroke-width="2"></path><text x="400" y="1080" fill="#000" font-family="monospace" font-size="13" text-anchor="middle" dominant-baseline="middle"><tspan x="400" dy="0">Apply OK?</tspan></text></g><g><rect x="70" y="747.5" width="160" height="65" rx="8" ry="8" fill="#fff0b3" stroke="#cc8400" stroke-width="2"></rect><text x="150" y="780" fill="#000" font-family="monospace" font-size="13" text-anchor="middle" dominant-baseline="middle"><tspan x="150" dy="-15.600000000000023">6a. Human</tspan><tspan x="150" dy="15.6">Intervention</tspan><tspan x="150" dy="15.6">(HITL)</tspan></text></g><g><rect x="320" y="747.5" width="160" height="65" rx="8" ry="8" fill="#e0e0e0" stroke="#555" stroke-width="2"></rect><text x="400" y="780" fill="#000" font-family="monospace" font-size="13" text-anchor="middle" dominant-baseline="middle"><tspan x="400" dy="0">6b. Auto Critique</tspan></text></g><g><path d="M 400 835 L 445 880 L 400 925 L 355 880 Z" fill="#e0f0e0" stroke="#4caf50" stroke-width="2"></path><text x="400" y="880" fill="#000" font-family="monospace" font-size="13" text-anchor="middle" dominant-baseline="middle"><tspan x="400" dy="0">Critique Pass?</tspan></text></g><g><rect x="570" y="747.5" width="160" height="65" rx="8" ry="8" fill="#e0e0e0" stroke="#555" stroke-width="2"></rect><text x="650" y="780" fill="#000" font-family="monospace" font-size="13" text-anchor="middle" dominant-baseline="middle"><tspan x="650" dy="0">6c. Critique Skipped</tspan></text></g><g><rect x="70" y="517.5" width="160" height="65" rx="8" ry="8" fill="#ffdddd" stroke="#d32f2f" stroke-width="2"></rect><text x="150" y="550" fill="#000" font-family="monospace" font-size="13" text-anchor="middle" dominant-baseline="middle"><tspan x="150" dy="-7.800000000000068">Generation</tspan><tspan x="150" dy="15.6">Failed</tspan></text></g><g><rect x="70" y="1047.5" width="160" height="65" rx="8" ry="8" fill="#ffdddd" stroke="#d32f2f" stroke-width="2"></rect><text x="150" y="1080" fill="#000" font-family="monospace" font-size="13" text-anchor="middle" dominant-baseline="middle"><tspan x="150" dy="-7.7999999999999545">Apply</tspan><tspan x="150" dy="15.6">Failed</tspan></text></g><g><path d="M 150 835 L 195 880 L 150 925 L 105 880 Z" fill="#e0f0e0" stroke="#ff9800" stroke-width="2"></path><text x="150" y="880" fill="#000" font-family="monospace" font-size="13" text-anchor="middle" dominant-baseline="middle"><tspan x="150" dy="-7.800000000000068">Retry Limit</tspan><tspan x="150" dy="15.6">Reached?</tspan></text></g><g><rect x="70" y="947.5" width="160" height="65" rx="8" ry="8" fill="#fff0b3" stroke="#d32f2f" stroke-width="2"></rect><text x="150" y="980" fill="#000" font-family="monospace" font-size="13" text-anchor="middle" dominant-baseline="middle"><tspan x="150" dy="-7.800000000000068">Forced Human</tspan><tspan x="150" dy="15.6">Intervention (Fail)</tspan></text></g><g><rect x="570" y="1147.5" width="160" height="65" rx="32.5" ry="32.5" fill="#f5f5f5" stroke="#333" stroke-width="2"></rect><text x="650" y="1180" fill="#000" font-family="monospace" font-size="13" text-anchor="middle" dominant-baseline="middle"><tspan x="650" dy="-7.7999999999999545">End</tspan><tspan x="650" dy="15.6">(Success)</tspan></text></g><g><rect x="320" y="1147.5" width="160" height="65" rx="32.5" ry="32.5" fill="#f5e0f5" stroke="#884488" stroke-width="2"></rect><text x="400" y="1180" fill="#000" font-family="monospace" font-size="13" text-anchor="middle" dominant-baseline="middle"><tspan x="400" dy="-7.7999999999999545">Pause</tspan><tspan x="400" dy="15.6">(Sandbox Review)</tspan></text></g><path d="M 400 82.5 L 400 117.5" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrowhead)"></path><path d="M 400 182.5 L 400 217.5" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrowhead)"></path><path d="M 400 282.5 L 400 317.5" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrowhead)"></path><path d="M 400 382.5 L 400 417.5" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrowhead)"></path><path d="M 400 482.5 L 400 505" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrowhead)"></path><rect x="401.4" y="593.5" width="17.2" height="13" fill="rgba(255, 255, 255, 0.7)" rx="3" ry="3"></rect><text x="410" y="600" fill="#000" font-family="monospace" font-size="11" text-anchor="middle" dominant-baseline="middle">OK</text><path d="M 400 595 L 400 605" stroke="#4caf50" stroke-width="2" fill="none" marker-end="url(#arrowhead-line_success)"></path><rect x="262.1135273664199" y="717.3721680123459" width="70" height="13" fill="rgba(255, 255, 255, 0.7)" rx="3" ry="3"></rect><text x="297.1135273664199" y="723.8721680123459" fill="#000" font-family="monospace" font-size="11" text-anchor="middle" dominant-baseline="middle">Human Req.</text><path d="M 355 650 L 230 780" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrowhead)"></path><rect x="365.1" y="714.75" width="89.8" height="13" fill="rgba(255, 255, 255, 0.7)" rx="3" ry="3"></rect><text x="410" y="721.25" fill="#000" font-family="monospace" font-size="11" text-anchor="middle" dominant-baseline="middle">Auto-Critique</text><path d="M 400 695 L 400 747.5" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrowhead)"></path><rect x="467.21352736641995" y="699.6278319876541" width="89.8" height="13" fill="rgba(255, 255, 255, 0.7)" rx="3" ry="3"></rect><text x="512.1135273664199" y="706.1278319876541" fill="#000" font-family="monospace" font-size="11" text-anchor="middle" dominant-baseline="middle">Skip Critique</text><path d="M 445 650 L 570 780" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrowhead)"></path><path d="M 400 812.5 L 400 835" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrowhead)"></path><rect x="394.8" y="929.75" width="30.4" height="13" fill="rgba(255, 255, 255, 0.7)" rx="3" ry="3"></rect><text x="410" y="936.25" fill="#000" font-family="monospace" font-size="11" text-anchor="middle" dominant-baseline="middle">Pass</text><path d="M 400 925 L 400 947.5" stroke="#4caf50" stroke-width="2" fill="none" marker-end="url(#arrowhead-line_success)"></path><rect x="224.26414804602928" y="850.0340344869776" width="30.4" height="13" fill="rgba(255, 255, 255, 0.7)" rx="3" ry="3"></rect><text x="239.46414804602927" y="856.5340344869776" fill="#000" font-family="monospace" font-size="11" text-anchor="middle" dominant-baseline="middle">Fail</text><path d="M 355 880 C 255 880, 130 780, 230 780" stroke="#f44336" stroke-width="2" fill="none" marker-end="url(#arrowhead-line_fail)"></path><rect x="273.04695047554424" y="849.4413119055697" width="96.39999999999999" height="13" fill="rgba(255, 255, 255, 0.7)" rx="3" ry="3"></rect><text x="321.2469504755442" y="855.9413119055697" fill="#000" font-family="monospace" font-size="11" text-anchor="middle" dominant-baseline="middle">Input Provided</text><path d="M 230 780 L 400 947.5" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrowhead)"></path><path d="M 570 780 L 400 947.5" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrowhead)"></path><rect x="226.8" y="963.5" width="96.39999999999999" height="13" fill="rgba(255, 255, 255, 0.7)" rx="3" ry="3"></rect><text x="275" y="970" fill="#000" font-family="monospace" font-size="11" text-anchor="middle" dominant-baseline="middle">Input Provided</text><path d="M 230 980 L 320 980" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrowhead)"></path><path d="M 400 1012.5 L 400 1035" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrowhead)"></path><rect x="502.613906763541" y="1114.2152330911474" width="17.2" height="13" fill="rgba(255, 255, 255, 0.7)" rx="3" ry="3"></rect><text x="511.21390676354105" y="1120.7152330911474" fill="#000" font-family="monospace" font-size="11" text-anchor="middle" dominant-baseline="middle">OK</text><path d="M 445 1080 L 570 1180" stroke="#4caf50" stroke-width="2" fill="none" marker-end="url(#arrowhead-line_success)"></path><rect x="384.9" y="1129.75" width="50.199999999999996" height="13" fill="rgba(255, 255, 255, 0.7)" rx="3" ry="3"></rect><text x="410" y="1136.25" fill="#000" font-family="monospace" font-size="11" text-anchor="middle" dominant-baseline="middle">Sandbox</text><path d="M 400 1125 L 400 1147.5" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrowhead)"></path><rect x="277.3" y="553.5" width="30.4" height="13" fill="rgba(255, 255, 255, 0.7)" rx="3" ry="3"></rect><text x="292.5" y="560" fill="#000" font-family="monospace" font-size="11" text-anchor="middle" dominant-baseline="middle">Fail</text><path d="M 355 550 L 230 550" stroke="#f44336" stroke-width="2" fill="none" marker-end="url(#arrowhead-line_fail)"></path><rect x="277.3" y="1083.5" width="30.4" height="13" fill="rgba(255, 255, 255, 0.7)" rx="3" ry="3"></rect><text x="292.5" y="1090" fill="#000" font-family="monospace" font-size="11" text-anchor="middle" dominant-baseline="middle">Fail</text><path d="M 355 1080 L 230 1080" stroke="#f44336" stroke-width="2" fill="none" marker-end="url(#arrowhead-line_fail)"></path><path d="M 150 582.5 L 150 835" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrowhead)"></path><path d="M 150 1047.5 L 150 925" stroke="#555" stroke-width="2" fill="none" marker-end="url(#arrowhead)"></path><rect x="84.89789073986616" y="520.7749237031959" width="109.6" height="13" fill="rgba(255, 255, 255, 0.7)" rx="3" ry="3"></rect><text x="139.69789073986615" y="527.2749237031959" fill="#000" font-family="monospace" font-size="11" text-anchor="middle" dominant-baseline="middle">Retry (Limit OK)</text><path d="M 150 835 C -50 835, 200 332.5, 400 282.5" stroke="#ff9800" stroke-width="2" fill="none" marker-end="url(#arrowhead-line_retry)"></path><rect x="115.1" y="929.75" width="89.8" height="13" fill="rgba(255, 255, 255, 0.7)" rx="3" ry="3"></rect><text x="160" y="936.25" fill="#000" font-family="monospace" font-size="11" text-anchor="middle" dominant-baseline="middle">Limit Reached</text><path d="M 150 925 L 150 947.5" stroke="#f44336" stroke-width="2" fill="none" marker-end="url(#arrowhead-line_fail)"></path></svg>
            </div>

            <h3>Understanding the Cycle and Human Roles</h3>
            <ul>
                <li><strong>Goal &amp; Planning (Steps 1-3):</strong> A <code>Goal</code> is defined. <code>Analyze</code> uses dynamic pathfinding on the Action Graph. <code>Propose</code> selects the plan (tool sequence).</li>
                <li><strong>Execution (Step 4):</strong> <code>Generate Artifacts</code> runs the chosen tools (MCP/FC calls).</li>
                <li><strong>Validation &amp; Critique (Steps 5-6):</strong> Checks if generation was OK and if <code>Critique</code> is needed. This step integrates Human-in-the-Loop (HITL) and automated checks:
                    <ul>
                        <li><strong>HITL as Critiquer/Modifier (Step 6a):</strong> If human input is requested or auto-critique fails, the human acts as a <code>critiquer</code> (evaluating the output) and potentially a <code>modifier</code> (providing corrections or specific guidance).</li>
                        <li><strong>Auto Critique (Step 6b):</strong> Automated checks run.</li>
                        <li><strong>Skip Critique (Step 6c):</strong> No critique needed.</li>
                    </ul>
                </li>
                <li><strong>Refinement &amp; Application (Step 7):</strong> Feedback is incorporated in <code>Refine &amp; Apply</code>.</li>
                <li><strong>Outcomes &amp; Failure Handling (Decisions, Retry, End):</strong> The final application is checked. Success leads to <code>End</code>. Failure routes to the retry loop. The loop goes back to <code>Analyze</code> to find a new path. If the <code>Retry Limit</code> is reached, the process requires <strong>HITL as Director/Solver (Forced Intervention)</strong>, where the human must provide a solution or redirect the agent fundamentally. The <code>Pause Sandbox</code> allows human review before final acceptance.</li>
            </ul>
             <p>This cycle explicitly combines automated execution, dynamic planning, recursive self-correction (retry loop), and critical points for human oversight and input, ensuring both efficiency and quality control.</p>
        </section>

        <section class="section">
          <h2>CUJ Examples: Tools, Workflows, and Optimization</h2>
          <p>Customer Journey Use Cases (CUJs) illustrate how DDAA uses tools and how the core algorithm applies.</p>

          <h3>Primary CUJ: Streamlined Design &amp; Code Generation</h3>
          <p>
              Workflow: "Engineer provides specs -&gt; <b>create_figma_file</b> (Script Agent) -&gt; [Optional: <b>get_user_feedback</b> (Human Agent) -&gt; <b>analyze_design_principles</b> (Script Agent)] -&gt; <b>generate_code_from_figma</b> (LLM Call/Script Agent) -&gt; Deploy".
          </p>
          <p>
              <strong>Algorithmic Relevance:</strong>
              This represents a path in the Action Graph. Frequent execution could lead to path compression, creating a single <code>design_to_deploy</code> tool. Dynamic pathfinding might choose different refinement loops (e.g., skipping feedback for simple changes). Personalization could tailor the available refinement tools based on team roles.
          </p>

          <h3>Secondary CUJ: Logo Creation</h3>
          <p>
              Workflow: "Request: 'Logo for X' -&gt; <b>generate_image_description</b> (LLM Call) -&gt; <b>generate_color_palette</b> (LLM Call) -&gt; <b>suggest_typography</b> (LLM Call) -&gt; <b>create_logo_image</b> (Webserver/LLM Agent)".
          </p>
          <p>
              <strong>Algorithmic Relevance:</strong> This common sequence is a prime candidate for <strong>path compression</strong>. DDAA could learn to create a single, higher-level tool <code>generate_logo_design</code>, making future logo requests much faster to plan and execute. This new tool is added to the Action Graph and potentially shared or personalized.
          </p>
        </section>

        <section class="section">
          <h2>Personalized Graphs &amp; Overlap</h2>
          <p>For scalability and relevance, DDAA utilizes personalized action graphs alongside a core graph.</p>

          <h3>Tailoring Action Graphs With Global and Individual Memory</h3>
          <p>Instead of one giant graph, each user or team can have a personalized Action Graph. This isn't built from scratch but is dynamically derived as a <strong>subset</strong> of the larger, shared "core" Action Graph, focusing on frequently used tools and compressed workflows relevant to that user/team.</p>

          <h3>Dynamic Subsetting and Overlap</h3>
          <p>The system learns a user's common paths (sequences) within the core graph. These paths form the basis of their personalized subgraph. Importantly, these subgraphs <strong>overlap</strong>, sharing common core functions (like <code>generate_image_description</code>) and potentially benefiting from optimizations (like path compressions) learned globally or by similar users.</p>
          <ul>
            <li><strong>Efficiency:</strong> Faster pathfinding within smaller, relevant subgraphs.</li>
            <li><strong>Relevance:</strong> Reduced cognitive load for users.</li>
            <li><strong>Adaptability:</strong> Subgraphs evolve with user behavior.</li>
            <li><strong>Knowledge Transfer:</strong> Shared nodes and potential for cross-pollination of learned efficiencies.</li>
          </ul>

          <h4>WIP: placeholder, replace with interactive demo </h4>
          <svg id="subgraph-viz-static" width="850" height="500" xmlns="http://www.w3.org/2000/svg">
              <title>Personalized Graphs: Dynamic Path Subsetting</title>
              <text x="425" y="50" font-size="20" text-anchor="middle" font-weight="bold">Personalized Graphs: Dynamic Path Subsetting</text>
              <g transform="translate(50, 100)">
                <text x="0" y="-20" font-size="14">Core Graph Path (Potential)</text>
                <rect x="0" y="0" width="80" height="30" stroke="black" stroke-width="1" fill="none"></rect>
                <text x="40" y="18" font-size="10" text-anchor="middle">Create Figma File</text>
                <rect x="160" y="0" width="80" height="30" stroke="black" stroke-width="1" fill="none"></rect>
                <text x="200" y="18" font-size="10" text-anchor="middle">Get User Feedback</text>
                <rect x="320" y="0" width="80" height="30" stroke="black" stroke-width="1" fill="none"></rect>
                <text x="360" y="18" font-size="10" text-anchor="middle">Generate Code</text>
                <rect x="480" y="0" width="80" height="30" stroke="black" stroke-width="1" fill="none"></rect>
                <text x="520" y="18" font-size="10" text-anchor="middle">Analyze Design</text>
                <rect x="640" y="0" width="80" height="30" stroke="black" stroke-width="1" fill="none"></rect>
                <text x="680" y="18" font-size="10" text-anchor="middle">Deploy Code</text>
                <path d="M80,15 L160,15" stroke="black" stroke-width="1" stroke-dasharray="5,5" marker-end="url(#arrow)"></path>
                <path d="M240,15 L320,15" stroke="black" stroke-width="1" stroke-dasharray="5,5" marker-end="url(#arrow)"></path>
                <path d="M400,15 L480,15" stroke="black" stroke-width="1" stroke-dasharray="5,5" marker-end="url(#arrow)"></path>
                <path d="M560,15 L640,15" stroke="black" stroke-width="1" stroke-dasharray="5,5" marker-end="url(#arrow)"></path>
                <text x="350" y="80" font-size="12" text-anchor="middle">(Longer, less frequent path in Core Graph)</text>
              </g>
              <g transform="translate(50, 300)">
                <text x="0" y="-20" font-size="14">Personalized Path (Frequent Subset for User)</text>
                <rect x="0" y="0" width="80" height="30" stroke="black" stroke-width="2" fill="none"></rect>
                <text x="40" y="18" font-size="10" text-anchor="middle">Create Figma File</text>
                <rect x="200" y="0" width="80" height="30" stroke="black" stroke-width="2" fill="none"></rect>
                <text x="240" y="18" font-size="10" text-anchor="middle">Generate Code</text>
                <rect x="400" y="0" width="80" height="30" stroke="black" stroke-width="2" fill="none"></rect>
                <text x="440" y="18" font-size="10" text-anchor="middle">Deploy Code</text>
                <path d="M80,15 L200,15" stroke="black" stroke-width="2" marker-end="url(#arrow)"></path>
                <path d="M280,15 L400,15" stroke="black" stroke-width="2" marker-end="url(#arrow)"></path>
                <path d="M0,0 L80,0 L80,30 L0,30 L0,0" stroke="red" stroke-width="1" fill="none"></path>
                <path d="M200,0 L280,0 L280,30 L200,30 L200,0" stroke="red" stroke-width="1" fill="none"></path>
                <path d="M400,0 L480,0 L480,30 L400,30 L400,0" stroke="red" stroke-width="1" fill="none"></path>
                <text x="240" y="80" font-size="12" text-anchor="middle">(Shorter, frequent path - Dynamic Subset)</text>
              </g>
              <defs>
                <marker id="arrow" viewBox="0 0 10 10" refX="10" refY="5" markerWidth="6" markerHeight="6" orient="auto-start-reverse">
                  <path d="M0 0 L10 5 L0 10 z" fill="black"></path>
                </marker>
              </defs>
            </svg>

          <h3>Personalization &amp; Continuous Optimization (Next Steps)</h3>
          <ul class="next-steps-list">
            <li><b>Dynamic Programming with Live Updates:</b> Explore algorithms for efficient path re-computation on graph changes.</li>
            <li><b>Continuous Path Compression &amp; Expansion:</b> Implement continuous monitoring and automated compression/expansion based on usage patterns.</li>
            <li><b>Personalized Graph Architectures:</b> Design structures for core/personal graph separation and contextual selection.</li>
            <li><b>Node Sharing and Graph Similarity:</b> Implement shared function nodes and use graph embeddings for similarity analysis and knowledge transfer.</li>
            <li><b>Federated Learning (Advanced):</b> Investigate privacy-preserving collaborative graph optimization.</li>
          </ul>
        </section>

    </div>

    <script>
        const cycleFlowData = {
          nodes: [
            { id: "start", label: "Start Cycle", type: "start_end", x: 400, y: 50 },
            { id: "step1", label: "1. Define Goal", type: "step", x: 400, y: 150 },
            { id: "step2", label: "2. Analyze\n(Pathfind/DP)", type: "iteration", x: 400, y: 250 },
            { id: "step3", label: "3. Propose\n(Plan)", type: "iteration", x: 400, y: 350 },
            { id: "step4", label: "4. Generate Artifacts\n(Exec Tools)", type: "iteration", x: 400, y: 450, },
            { id: "decision_gen", label: "Generation OK?", type: "decision", x: 400, y: 550, },
            { id: "step5", label: "5. Critique Trigger?", type: "decision", x: 400, y: 650, },
            { id: "step7", label: "7. Refine & Apply", type: "step", x: 400, y: 980 },
            { id: "decision_apply", label: "Apply OK?", type: "decision", x: 400, y: 1080, },
            { id: "step6_human", label: "6a. Human\nIntervention\n(HITL)", type: "intervention", x: 150, y: 780, },
            { id: "step6_auto", label: "6b. Auto Critique", type: "step", x: 400, y: 780, },
            { id: "decision_auto_crit", label: "Critique Pass?", type: "decision", x: 400, y: 880, },
            { id: "step6_skip", label: "6c. Critique Skipped", type: "step", x: 650, y: 780, },
            { id: "fail_point_gen", label: "Generation\nFailed", type: "fail_point", x: 150, y: 550, },
            { id: "fail_point_apply", label: "Apply\nFailed", type: "fail_point", x: 150, y: 1080, },
            { id: "decision_retry_limit", label: "Retry Limit\nReached?", type: "retry_decision", x: 150, y: 880, },
            { id: "human_intervention_final", label: "Forced Human\nIntervention (Fail)", type: "final_intervention", x: 150, y: 980, },
            { id: "end_success", label: "End\n(Success)", type: "start_end", x: 650, y: 1180, },
            { id: "pause_sandbox", label: "Pause\n(Sandbox Review)", type: "pause", x: 400, y: 1180, },
          ],
          connections: [
            { from: "start", to: "step1", type: "normal" }, { from: "step1", to: "step2", type: "normal" },
            { from: "step2", to: "step3", type: "normal" }, { from: "step3", to: "step4", type: "normal" },
            { from: "step4", to: "decision_gen", type: "normal" }, { from: "decision_gen", to: "step5", type: "success", label: "OK" },
            { from: "step5", to: "step6_human", type: "normal", label: "Human Req." }, { from: "step5", to: "step6_auto", type: "normal", label: "Auto-Critique" },
            { from: "step5", to: "step6_skip", type: "normal", label: "Skip Critique" }, { from: "step6_auto", to: "decision_auto_crit", type: "normal" },
            { from: "decision_auto_crit", to: "step7", type: "success", label: "Pass" }, { from: "decision_auto_crit", to: "step6_human", type: "fail", label: "Fail" },
            { from: "step6_human", to: "step7", type: "normal", label: "Input Provided", }, { from: "step6_skip", to: "step7", type: "normal" },
            { from: "human_intervention_final", to: "step7", type: "normal", label: "Input Provided", }, { from: "step7", to: "decision_apply", type: "normal" },
            { from: "decision_apply", to: "end_success", type: "success", label: "OK" }, { from: "decision_apply", to: "pause_sandbox", type: "normal", label: "Sandbox", },
            { from: "decision_gen", to: "fail_point_gen", type: "fail", label: "Fail" }, { from: "decision_apply", to: "fail_point_apply", type: "fail", label: "Fail", },
            { from: "fail_point_gen", to: "decision_retry_limit", type: "normal" }, { from: "fail_point_apply", to: "decision_retry_limit", type: "normal" },
            { from: "decision_retry_limit", to: "step2", type: "retry", label: "Retry (Limit OK)", }, { from: "decision_retry_limit", to: "human_intervention_final", type: "fail", label: "Limit Reached", },
          ],
        };

        function renderCycleSVG(cycleData, svgId) {
          const svgNs = "http://www.w3.org/2000/svg";
          const svg = document.getElementById(svgId);
          if (!svg) { return; }
          while (svg.firstChild) { svg.removeChild(svg.firstChild); }
          const config = { nodeWidth: 160, nodeHeight: 65, decisionSize: 90, padding: 40, arrowSize: 8, strokeWidth: 2, fontSize: 13, fontFamily: "monospace", lineLabelFontSize: 11,
            colors: { step: { fill: "#e0e0e0", stroke: "#555" }, iteration: { fill: "#d0e0ff", stroke: "#3366cc" }, intervention: { fill: "#fff0b3", stroke: "#cc8400" }, decision: { fill: "#e0f0e0", stroke: "#4caf50" }, start_end: { fill: "#f5f5f5", stroke: "#333" }, pause: { fill: "#f5e0f5", stroke: "#884488" }, fail_point: { fill: "#ffdddd", stroke: "#d32f2f" }, retry_decision: { fill: "#e0f0e0", stroke: "#ff9800" }, final_intervention: { fill: "#fff0b3", stroke: "#d32f2f" }, text: "#000", line_normal: "#555", line_success: "#4caf50", line_fail: "#f44336", line_retry: "#ff9800", line_label_bg: "rgba(255, 255, 255, 0.7)", },
          };
          const defs = document.createElementNS(svgNs, "defs");
          const marker = document.createElementNS(svgNs, "marker");
          marker.setAttribute("id", "arrowhead"); marker.setAttribute("viewBox", "0 0 10 10"); marker.setAttribute("refX", "8"); marker.setAttribute("refY", "5"); marker.setAttribute("markerUnits", "strokeWidth"); marker.setAttribute("markerWidth", config.arrowSize); marker.setAttribute("markerHeight", config.arrowSize); marker.setAttribute("orient", "auto-start-reverse");
          const path = document.createElementNS(svgNs, "path"); path.setAttribute("d", "M 0 0 L 10 5 L 0 10 z"); path.setAttribute("fill", config.colors.line_normal); marker.appendChild(path); defs.appendChild(marker);
          ["line_normal", "line_success", "line_fail", "line_retry"].forEach( (lineType) => { if (lineType === "line_normal") return; const markerColor = document.createElementNS(svgNs, "marker"); markerColor.setAttribute("id", `arrowhead-${lineType}`); markerColor.setAttribute("viewBox", "0 0 10 10"); markerColor.setAttribute("refX", "8"); markerColor.setAttribute("refY", "5"); markerColor.setAttribute("markerUnits", "strokeWidth"); markerColor.setAttribute("markerWidth", config.arrowSize); markerColor.setAttribute("markerHeight", config.arrowSize); markerColor.setAttribute("orient", "auto-start-reverse"); const pathColor = document.createElementNS(svgNs, "path"); pathColor.setAttribute("d", "M 0 0 L 10 5 L 0 10 z"); pathColor.setAttribute("fill", config.colors[lineType]); markerColor.appendChild(pathColor); defs.appendChild(markerColor); });
          svg.appendChild(defs);
          function createSvgElement(name, attrs = {}) { const el = document.createElementNS(svgNs, name); for (const key in attrs) { el.setAttribute(key, attrs[key]); } return el; }
          function getNodeById(id) { return cycleData.nodes.find((n) => n.id === id); }
          let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity; const nodeElements = {};
          cycleData.nodes.forEach((node) => { const group = createSvgElement("g"); let shape; const style = config.colors[node.type] || config.colors.step; const halfWidth = (node.type === "decision" || node.type === "retry_decision" ? config.decisionSize : config.nodeWidth) / 2; const halfHeight = (node.type === "decision" || node.type === "retry_decision" ? config.decisionSize : config.nodeHeight) / 2;
            if (node.type === "decision" || node.type === "retry_decision") { shape = createSvgElement("path", { d: `M ${node.x} ${node.y - halfHeight} L ${node.x + halfWidth} ${ node.y } L ${node.x} ${node.y + halfHeight} L ${node.x - halfWidth} ${ node.y } Z`, fill: style.fill, stroke: style.stroke, "stroke-width": config.strokeWidth, }); node.bounds = { top: { x: node.x, y: node.y - halfHeight }, bottom: { x: node.x, y: node.y + halfHeight }, left: { x: node.x - halfWidth, y: node.y }, right: { x: node.x + halfWidth, y: node.y }, }; } else { const isRound = node.type === "start_end" || node.type === "pause"; shape = createSvgElement("rect", { x: node.x - halfWidth, y: node.y - halfHeight, width: config.nodeWidth, height: config.nodeHeight, rx: isRound ? config.nodeHeight / 2 : 8, ry: isRound ? config.nodeHeight / 2 : 8, fill: style.fill, stroke: style.stroke, "stroke-width": config.strokeWidth, }); node.bounds = { top: { x: node.x, y: node.y - halfHeight }, bottom: { x: node.x, y: node.y + halfHeight }, left: { x: node.x - halfWidth, y: node.y }, right: { x: node.x + halfWidth, y: node.y }, }; } group.appendChild(shape);
            const text = createSvgElement("text", { x: node.x, y: node.y, fill: config.colors.text, "font-family": config.fontFamily, "font-size": config.fontSize, "text-anchor": "middle", "dominant-baseline": "middle", });
            const lines = node.label.split("\n"); const lineHeight = config.fontSize * 1.2; const totalTextHeight = lines.length * lineHeight; const startY = node.y - totalTextHeight / 2 + lineHeight / 2;
            lines.forEach((line, index) => { const dy = index === 0 ? startY - node.y : lineHeight; const tspan = createSvgElement("tspan", { x: node.x, dy: `${dy}`, }); tspan.textContent = line; text.appendChild(tspan); }); group.appendChild(text); svg.appendChild(group); nodeElements[node.id] = group;
            const nodeMaxX = node.bounds.right.x; const nodeMinX = node.bounds.left.x; const nodeMaxY = node.bounds.bottom.y; const nodeMinY = node.bounds.top.y; minX = Math.min(minX, nodeMinX); minY = Math.min(minY, nodeMinY); maxX = Math.max(maxX, nodeMaxX); maxY = Math.max(maxY, nodeMaxY);
          });
          cycleData.connections.forEach((conn) => { const fromNode = getNodeById(conn.from); const toNode = getNodeById(conn.to); if (!fromNode || !toNode) { return; } let startPoint, endPoint; const dx = toNode.x - fromNode.x; const dy = toNode.y - fromNode.y;
            if (Math.abs(dy) > Math.abs(dx) * 1.5 || (conn.from === "decision_auto_crit" && conn.to === "step6_human")) { startPoint = dy > 0 ? fromNode.bounds.bottom : fromNode.bounds.top; endPoint = dy > 0 ? toNode.bounds.top : toNode.bounds.bottom; if(conn.from === "decision_auto_crit" && conn.to === "step6_human"){startPoint = fromNode.bounds.left; endPoint = toNode.bounds.right;} } else if (Math.abs(dx) > Math.abs(dy) * 1.5 || (conn.from === "decision_retry_limit" && conn.to === "step2")) { startPoint = dx > 0 ? fromNode.bounds.right : fromNode.bounds.left; endPoint = dx > 0 ? toNode.bounds.left : toNode.bounds.right; } else { startPoint = dy > 0 ? (dx > 0 ? fromNode.bounds.right : fromNode.bounds.left) : fromNode.bounds.top; endPoint = dy > 0 ? toNode.bounds.top : (dx > 0 ? toNode.bounds.left : toNode.bounds.right); if (dx === 0) { startPoint = dy > 0 ? fromNode.bounds.bottom : fromNode.bounds.top; endPoint = dy > 0 ? toNode.bounds.top : toNode.bounds.bottom; } }
            const lineType = conn.type || "normal"; const lineStyle = config.colors[`line_${lineType}`] || config.colors.line_normal; const markerId = `arrowhead${ lineType === "normal" ? "" : "-" + "line_" + lineType }`; let d_attr;
            if(conn.from === "decision_retry_limit" && conn.to === "step2") { const controlX1 = startPoint.x - 200; const controlY1 = startPoint.y; const controlX2 = endPoint.x - 200; const controlY2 = endPoint.y + 50; d_attr = `M ${startPoint.x} ${startPoint.y} C ${controlX1} ${controlY1}, ${controlX2} ${controlY2}, ${endPoint.x} ${endPoint.y}`; } else if (conn.from === "decision_auto_crit" && conn.to === "step6_human") { const controlX1 = startPoint.x - 100; const controlY1 = startPoint.y; const controlX2 = endPoint.x - 100; const controlY2 = endPoint.y; d_attr = `M ${startPoint.x} ${startPoint.y} C ${controlX1} ${controlY1}, ${controlX2} ${controlY2}, ${endPoint.x} ${endPoint.y}`; } else { d_attr = `M ${startPoint.x} ${startPoint.y} L ${endPoint.x} ${endPoint.y}`; }
            const line = createSvgElement("path", { d: d_attr, stroke: lineStyle, "stroke-width": config.strokeWidth, fill: "none", "marker-end": `url(#${markerId})`, }); svg.appendChild(line);
            if (conn.label) { let midPoint = { x: (startPoint.x + endPoint.x) / 2, y: (startPoint.y + endPoint.y) / 2 }; try { if(line.getPointAtLength) { const pathLength = line.getTotalLength(); midPoint = line.getPointAtLength(pathLength * 0.5); } } catch(e) {} const angle = Math.atan2(dy, dx); const offsetX = Math.sin(angle) * 10; const offsetY = -Math.cos(angle) * 10;
              const textLabel = createSvgElement("text", { x: midPoint.x + offsetX, y: midPoint.y + offsetY, fill: config.colors.text, "font-family": config.fontFamily, "font-size": config.lineLabelFontSize, "text-anchor": "middle", "dominant-baseline": "middle", }); textLabel.textContent = conn.label;
              const labelWidthEstimate = conn.label.length * config.lineLabelFontSize * 0.6; const labelHeightEstimate = config.lineLabelFontSize; const bgRect = createSvgElement("rect", { x: midPoint.x + offsetX - labelWidthEstimate / 2 - 2, y: midPoint.y + offsetY - labelHeightEstimate / 2 - 1, width: labelWidthEstimate + 4, height: labelHeightEstimate + 2, fill: config.colors.line_label_bg, rx: 3, ry: 3, });
              svg.insertBefore(bgRect, line); svg.insertBefore(textLabel, line);
              minX = Math.min(minX, parseFloat(bgRect.getAttribute("x"))); minY = Math.min(minY, parseFloat(bgRect.getAttribute("y"))); maxX = Math.max(maxX, parseFloat(bgRect.getAttribute("x")) + parseFloat(bgRect.getAttribute("width")) ); maxY = Math.max(maxY, parseFloat(bgRect.getAttribute("y")) + parseFloat(bgRect.getAttribute("height")) );
            }
          });
          if (isFinite(minX)) { const viewBoxX = minX - config.padding; const viewBoxY = minY - config.padding; const viewBoxWidth = maxX - minX + 2 * config.padding; const viewBoxHeight = maxY - minY + 2 * config.padding; svg.setAttribute( "viewBox", `${viewBoxX} ${viewBoxY} ${viewBoxWidth} ${viewBoxHeight}` ); svg.setAttribute("preserveAspectRatio", "xMidYMid meet"); } else { svg.setAttribute("viewBox", "0 0 800 1400"); }
        }

        let compressionVisible = false;
        function toggleCompression() {
            compressionVisible = !compressionVisible;
            const uncompressed = document.getElementById('uncompressed-path');
            const compressed = document.getElementById('compressed-path');
            const container = document.getElementById('compression-example-container');
            if (uncompressed && compressed && container) {
                 uncompressed.classList.toggle('hidden', compressionVisible);
                 compressed.classList.toggle('hidden', !compressionVisible);
                 const button = container.querySelector('button[onclick="toggleCompression()"]');
                 if(button) { button.textContent = compressionVisible ? 'Show Uncompressed Path' : 'Show Compressed Path'; }
            }
        }

        let subgraphView = 'core';
        function toggleSubgraphView() {
             const coreNodes = document.getElementById('core-graph-nodes');
             const personalNodes = document.getElementById('personal-subgraph-nodes');
             const textElement = document.getElementById('subgraph-text');
             const container = document.getElementById('subgraph-example-container');
             if (coreNodes && personalNodes && textElement && container) {
                 const button = container.querySelector('button[onclick="toggleSubgraphView()"]');
                 if (subgraphView === 'core') {
                    coreNodes.classList.remove('subgraph-core'); personalNodes.classList.add('hidden');
                    textElement.textContent = 'Showing Full Core Graph';
                    if(button) button.textContent = 'Show Personalized Subgraph';
                    subgraphView = 'personal';
                 } else {
                     coreNodes.classList.add('subgraph-core'); personalNodes.classList.remove('hidden');
                     textElement.textContent = 'Core Graph with Personalized Subgraph (Purple)';
                     if(button) button.textContent = 'Show Full Core Graph';
                     subgraphView = 'core';
                 }
             }
        }

        document.addEventListener("DOMContentLoaded", () => {
          renderCycleSVG(cycleFlowData, "cycleDiagram");
          const compContainer = document.getElementById('compression-example-container');
          if (!compContainer) { const compButton = document.querySelector('button[onclick="toggleCompression()"]'); if (compButton) compButton.style.display = 'none'; }
          const subContainer = document.getElementById('subgraph-example-container');
          if (!subContainer) { const subButton = document.querySelector('button[onclick="toggleSubgraphView()"]'); if (subButton) subButton.style.display = 'none'; }
        });

    </script>


</body></html>